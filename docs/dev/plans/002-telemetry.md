# Telemetry System PRD

**Status:** Draft  
**Created:** 2026-02-22  
**Component:** Telemetry  
**Prerequisites:** Agent Trace specification (https://agent-trace.dev/)

---

## 1. Overview

### 1.1 Problem Statement

As AI agents become more autonomous in writing code, developers need visibility into:
- What code was generated by AI versus humans
- How agents make decisions and take actions
- The complete workflow of agent sessions
- Error patterns and recovery behaviors

### 1.2 Goals

1. **Attribution Tracking**: Implement Agent Trace specification for tracking AI-generated code contributions with line-level granularity
2. **Behavior Telemetry**: Capture agent actions, decisions, and outcomes through spans and events
3. **Session Tracing**: Track complete agent sessions from start to finish with context propagation
4. **Local Storage**: Provide local trace storage with JSON format compatible with Agent Trace spec
5. **CLI Integration**: Enable trace inspection through CLI commands
6. **Privacy Controls**: Implement PII scrubbing and configurable sampling

### 1.3 Non-Goals

- Real-time streaming to external systems (Phase 2)
- Web dashboard (Phase 3)
- Code quality assessment
- Legal ownership tracking
- Training data provenance

---

## 2. Architecture

### 2.1 System Architecture

```
┌────────────────────────────────────────────────────────────────┐
│                        Nexus Core                               │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐   │
│  │   Boulder    │────▶│  Telemetry   │────▶│   Storage    │   │
│  │   Enforcer   │     │  Collector   │     │  (.nexus/)   │   │
│  └──────────────┘     └──────────────┘     └──────────────┘   │
└────────────────────────────────────────────────────────────────┘
```

### 2.2 Core Components

| Component | Responsibility |
|-----------|----------------|
| `TelemetryCollector` | Central hub for collecting events from all sources |
| `HookSystem` | Manages before/after hooks for tool execution |
| `Processor` | Enriches events with context and attributes |
| `Sampler` | Samples events based on configuration |
| `TraceWriter` | Persists traces to local storage |
| `QueryEngine` | Queries and filters stored traces |

### 2.3 Data Model

```typescript
interface Trace {
  id: string;
  version: string;  // Agent Trace spec version
  timestamp: string;
  session_id: string;
  
  // Agent Trace fields
  vcs?: VCS;
  tool?: Tool;
  files: FileAttribution[];
  
  // Telemetry fields
  spans: Span[];
  metadata: Record<string, unknown>;
}

interface Contributor {
  type: 'human' | 'ai' | 'mixed' | 'unknown';
  model_id?: string;  // e.g., "anthropic/claude-sonnet-4-20250514"
}

interface Span {
  id: string;
  parent_id?: string;
  name: string;
  type: SpanType;
  start_time: number;
  end_time?: number;
  attributes: Record<string, unknown>;
  events: SpanEvent[];
  status: SpanStatus;
}

type SpanType = 
  | 'tool.execute'
  | 'enforcement.idle'
  | 'enforcement.message'
  | 'decision'
  | 'error'
  | 'session.start'
  | 'session.end';
```

---

## 3. Features

### 3.1 Automatic Trace Collection

The system automatically captures traces through hook points:

| Hook Point | Captured Data |
|------------|---------------|
| `tool.execute.before` | Tool name, arguments, invocation context |
| `tool.execute.after` | Tool result, duration, success/failure |
| `enforcement.idle` | Idle detection events, idle duration |
| `session.start` | Session metadata, workspace context |
| `session.end` | Session summary, outcome |

### 3.2 CLI Commands

```bash
# List traces
nexus trace list [--limit N] [--from DATE] [--to DATE]

# Show trace details
nexus trace show <trace_id> [--spans] [--attribution]

# Export trace
nexus trace export <trace_id> --format FORMAT --output FILE

# Delete old traces
nexus trace prune [--older-than DAYS]

# Show storage stats
nexus trace stats
```

### 3.3 Privacy Controls

**PII Scrubbing:**
- SSN: `[SSN]`
- Email: `[EMAIL]`
- API Key: `[API_KEY]`
- Excluded paths: `~/.ssh/*`, `~/.aws/credentials`

**Sampling Options:**
- 1% - Production, high volume
- 10% - Normal operation
- 100% - Development/debugging

---

## 4. Storage

### 4.1 Local Storage

```
.nexus/
└── traces/
    ├── 2026-02-22/
    │   ├── trace-a1b2c3d4.json
    │   └── ...
    └── index.json
```

### 4.2 Retention Policy

| Configuration | Value |
|---------------|-------|
| Default | 30 days |
| Minimum | 1 day |
| Maximum | 365 days |
| Cleanup | Daily at 03:00 UTC |

---

## 5. Configuration

```yaml
# ~/.nexus/config.yaml
telemetry:
  enabled: true
  sampling:
    rate: 100
  retention:
    days: 30
  privacy:
    scrub_pii: true
  export:
    enabled: false
    endpoint: ""
```

---

## 6. Implementation Plan

### Phase 1: Core Infrastructure (Week 1-2)
- [ ] Create telemetry package structure
- [ ] Implement Trace, Span, Event data models
- [ ] Build TelemetryCollector service
- [ ] Implement trace storage (JSON files)

### Phase 2: Hook Integration (Week 3)
- [ ] Integrate with Boulder Enforcer events
- [ ] Add tool execution hooks
- [ ] Implement session lifecycle tracking

### Phase 3: Attribution (Week 4)
- [ ] Implement file diff tracking
- [ ] Build contributor attribution logic
- [ ] Implement PII scrubbing

### Phase 4: CLI (Week 5)
- [ ] Implement `nexus trace list`
- [ ] Implement `nexus trace show`
- [ ] Implement `nexus trace export`

### Phase 5: Export & Polish (Week 6)
- [ ] Add Jaeger/Zipkin export
- [ ] Implement retention policy
- [ ] Performance optimization

---

## 7. References

- [Agent Trace Specification](https://agent-trace.dev/)
- [ADR-003: Telemetry Design](../decisions/003-telemetry-design.md)

---

**Last Updated:** February 2026
