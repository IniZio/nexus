version: '3'

tasks:
  build:
    desc: Build all packages
    cmds:
      - task: build:core
      - task: build:opencode
      - task: build:nexusd
      # - task: build:claude
      # - task: build:cursor

  build:core:
    dir: packages/core
    cmds:
      - pnpm install
      - pnpm build

  build:opencode:
    dir: packages/opencode
    cmds:
      - pnpm install
      - pnpm build

  build:claude:
    dir: packages/claude
    cmds:
      - pnpm install
      - pnpm build

  build:cursor:
    dir: packages/cursor
    cmds:
      - pnpm install
      - pnpm build

  test:
    desc: Run all tests
    cmds:
      - task: test:core
      - task: test:opencode
      # - task: test:claude
      # - task: test:cursor
      - task: test:nexusd

  test:core:
    dir: packages/core
    cmds:
      - pnpm test

  test:opencode:
    dir: packages/opencode
    cmds:
      - pnpm test

  test:claude:
    dir: packages/claude
    cmds:
      - pnpm test

  test:cursor:
    dir: packages/cursor
    cmds:
      - pnpm test

  lint:
    desc: Run all linters
    cmds:
      - pnpm run lint:ts
      - pnpm run lint:go

  lint:core:
    dir: packages/core
    cmds:
      - pnpm lint

  lint:opencode:
    dir: packages/opencode
    cmds:
      - pnpm lint

  lint:claude:
    dir: packages/claude
    cmds:
      - pnpm lint

  lint:cursor:
    dir: packages/cursor
    cmds:
      - pnpm lint

  build:nexus:
    dir: packages/nexus
    cmds:
      - go build -o nexus ./cmd/daemon

  build:nexusd:
    dir: packages/nexusd
    cmds:
      - go build -o nexusd ./cmd/daemon

  test:nexusd:
    dir: packages/nexusd
    cmds:
      - go test ./...
    env:
      SKIP_E2E: "true"

  ci:
    desc: Run CI pipeline - install, build, lint, test
    cmds:
      - pnpm install
      - task: build
      - task: lint
      - task: test

  publish:
    desc: Publish all packages to npm
    cmds:
      - task: publish:core
      - task: publish:opencode
      - task: publish:claude
      - task: publish:cursor

  publish:core:
    dir: packages/core
    cmds:
      - pnpm publish

  publish:opencode:
    dir: packages/opencode
    cmds:
      - pnpm publish

  publish:claude:
    dir: packages/claude
    cmds:
      - pnpm publish

  publish:cursor:
    dir: packages/cursor
    cmds:
      - pnpm publish

  clean:
    desc: Clean all build artifacts
    cmds:
      - rm -rf packages/core/dist
      - rm -rf packages/opencode/dist
      - rm -rf packages/claude/dist
      - rm -rf packages/cursor/dist
      - rm -rf packages/nexusd/nexusd

  download-mutagen:
    desc: Download Mutagen binaries for embedding
    cmds:
      - scripts/download-mutagen.sh
